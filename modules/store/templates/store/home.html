<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Circle K & GS25 ‚Äì T√¨m c·ª≠a h√†ng g·∫ßn b·∫°n</title>

  <!-- ================= LEAFLET & PLUGINS ================= -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- ================= STYLE ================= -->
  <style>
    :root {
      --bg: #f8f9ff;
      --card: #ffffff;
      --border: #e0e7ff;
      --ink: #0f172a;
      --muted: #64748b;
      --shadow: 0 10px 30px rgba(0,0,0,.08);

      --red: #e31c23;
      --red2: #c3141a;
      --yellow: #ffd100;
      --blue: #2563eb;
      --green: #16a34a;

      --container: 1280px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f8f9ff 0%, #eef2ff 100%);
      color: var(--ink);
      line-height: 1.6;
    }
    a { text-decoration: none; color: inherit; }

    /* ================= HEADER ================= */
    header {
      background: linear-gradient(135deg, var(--red) 0%, var(--red2) 100%);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 6px 20px rgba(227,28,35,.25);
    }
    header .wrap {
      max-width: var(--container);
      margin: auto;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }
    .logo {
      font-size: 32px;
      font-weight: 900;
      letter-spacing: 1.5px;
      color: white;
    }
    .logo span { color: var(--yellow); }
    nav {
      display: flex;
      gap: 32px;
    }
    nav a {
      color: white;
      font-weight: 700;
      font-size: 15px;
      transition: all 0.2s;
    }
    nav a:hover {
      color: var(--yellow);
      transform: translateY(-1px);
    }
    .btnFind {
      background: var(--yellow);
      color: #111;
      padding: 12px 28px;
      border-radius: 999px;
      font-weight: 800;
      box-shadow: 0 4px 16px rgba(255,209,0,.4);
      transition: all 0.25s;
    }
    .btnFind:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255,209,0,.5);
    }

    /* ================= HERO ================= */
.hero {
  height: calc(100vh - 80px); /* tr·ª´ chi·ªÅu cao header */
  min-height: 600px;
  background:
    linear-gradient(rgba(75, 67, 67, 0.45), rgba(89, 84, 84, 0.45)),
    url("https://images.unsplash.com/photo-1604719312566-8912e9227c6a?auto=format&fit=crop&w=2000&q=80")
    center / cover no-repeat;

  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}
    .hero-content {
      position: relative;
      z-index: 2;
      max-width: 900px;
      padding: 0 20px;
    }
    .hero h1 {
      font-size: clamp(48px, 9vw, 84px);
      font-weight: 900;
      margin: 0 0 20px;
      letter-spacing: -1px;
      text-shadow: 0 6px 20px rgba(226, 209, 209, 0.5);
    }
   .hero p {
  color: #f1f5f9;                  /* tr·∫Øng x√°m nh·∫π */
  font-size: 22px;
  text-shadow: 0 4px 18px rgba(239, 230, 230, 0.45);
}
    .hero .btn {
      background: var(--yellow);
      color: #111827;
      padding: 18px 48px;
      border-radius: 999px;
      font-size: 20px;
      font-weight: 800;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      transition: all 0.3s;
    }
    .hero .btn:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 16px 40px rgba(255,209,0,0.6);
    }

    /* ================= SECTION ================= */
    section { padding: 100px 20px; }

    section h2 {
      text-align: center;
      font-size: 42px;
      font-weight: 900;
      margin: 0 0 50px;
      color: var(--ink);
    }

    /* ================= ABOUT ================= */
    .about {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      margin: 0 auto;
      max-width: 1100px;
      padding: 60px 40px;
      box-shadow: var(--shadow);
    }
    .about p {
      max-width: 920px;
      margin: auto;
      text-align: center;
      font-size: 18px;
      line-height: 1.8;
      color: #334155;
    }

    /* ================= PRODUCTS ================= */
    .products {
      background: linear-gradient(180deg, #f0f5ff 0%, #e5edff 100%);
    }
    .product-grid {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 28px;
    }
    .product-card {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.28s ease;
      position: relative;
    }
    .product-card:hover {
      transform: translateY(-12px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    .product-card img {
      width: 100%;
      height: 240px;
      object-fit: cover;
      transition: transform 0.4s;
    }
    .product-card:hover img {
      transform: scale(1.08);
    }
    .product-info {
      padding: 24px;
      text-align: center;
    }
    .product-info h3 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 800;
      color: var(--ink);
    }
    .product-info p {
      color: var(--muted);
      font-size: 15px;
      margin: 0;
    }

    /* ================= STORE LOCATOR ================= */
    .store-locator {
      background: linear-gradient(180deg, #f8f9ff, #ffffff);
      padding: 100px 0;
    }

    .wrapMain {
      max-width: var(--container);
      margin: 40px auto 0;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 440px 1fr;
      gap: 24px;
    }
    @media (max-width: 1024px) {
      .wrapMain { grid-template-columns: 1fr; }
    }

    /* ================= LEFT PANEL (CONTROL + LIST) ================= */
    .panel {
      background: #fff;
      border-radius: 24px;
      padding: 18px;
      box-shadow: 0 14px 36px rgba(0,0,0,.14);
      overflow: hidden;
    }

    .topbar {
      background: linear-gradient(180deg, var(--red), var(--red2));
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: var(--shadow);
    }
    .topbar .wrap {
      max-width: var(--container);
      margin: 0 auto;
      padding: 10px 14px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .brandPill {
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
    }
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tab {
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      padding: 8px 10px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      font-weight: 900;
    }
    .tab.active {
      background: #fff;
      color: var(--red);
      border-color: transparent;
    }

    .cardHead {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, #fff, #fff8f8);
      font-weight: 1000;
      font-size: 13px;
    }
    .cardBody { padding: 12px 14px; }

    .status {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }
    .dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--green);
    }
    .dot.bad { background: #ef4444; }

    .searchBox {
      display: flex;
      gap: 10px;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 12px;
      background: #fff;
    }
    .pin {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(37,99,235,.12);
      border: 1px solid rgba(37,99,235,.25);
      color: var(--blue);
      font-weight: 1000;
    }
    .searchBox input {
      width: 100%;
      border: none;
      outline: none;
      font-size: 14px;
      font-weight: 800;
    }
    .btn {
      border: none;
      cursor: pointer;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 1000;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
      user-select: none;
    }
    .btn:active { transform: translateY(1px); }
    .btnPrimary { background: linear-gradient(180deg, #ffd100, #ffc400); color: #111827; }
    .btnWhite { background: #fff; color: #111827; border: 1px solid var(--border); }
    .btnBlue { background: linear-gradient(180deg, #3b82f6, #2563eb); color: #fff; }

    .hint {
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      line-height: 1.45;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    .field {
      flex: 1;
      min-width: 150px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
    }
    label { display: block; font-size: 12px; color: var(--muted); font-weight: 900; margin-bottom: 6px; }
    select, input { width: 100%; border: none; outline: none; background: transparent; font-size: 13px; font-weight: 800; }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 45vh;
      overflow: auto;
      padding-right: 4px;
    }
    .item {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      cursor: pointer;
      background: #fff;
      transition: transform .08s ease, box-shadow .12s ease;
    }
    .item:hover {
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
      transform: translateY(-1px);
    }
    .item b { display: block; font-size: 13px; }
    .item small { display: block; color: var(--muted); margin-top: 4px; line-height: 1.35; }
    .actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .mini { padding: 6px 10px; border-radius: 999px; }

    #map { height: 72vh; min-height: 520px; border-radius: 18px; }

    /* Autocomplete */
    .acWrap { position: relative; }
    .acList {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 6px);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow: hidden;
      z-index: 50;
      max-height: 260px;
      overflow: auto;
      display: none;
    }
    .acItem {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      font-size: 13px;
      font-weight: 800;
    }
    .acItem:last-child { border-bottom: none; }
    .acItem:hover { background: #f8fafc; }

    /* ================= FOOTER ================= */
    footer {
      background: #0f172a;
      color: #cbd5f5;
      text-align: center;
      padding: 40px 20px;
      font-size: 14px;
    }

    /* Thu nh·ªè attribution Leaflet */
    .leaflet-control-attribution {
     font-size: 10px;
     opacity: 0.4;
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>

<body>

<!-- ================= HEADER ================= -->
<header>
  <div class="wrap">
    <div class="logo">CIRCLE <span>K & GS25</span></div>

    <nav>
      <a href="#about">Gi·ªõi thi·ªáu</a>
      <a href="#products">S·∫£n ph·∫©m</a>
      <a href="#stores">C·ª≠a h√†ng</a>
    </nav>

    <div style="display:flex;gap:10px;align-items:center">
      <a href="#stores" class="btnFind">T√¨m c·ª≠a h√†ng</a>
      <a href="/admin/" class="btn btnWhite mini">Admin</a>
    </div>
  </div>
</header>

<!-- ================= HERO ================= -->
<section class="hero">
  <div class="hero-content">
    <h1>Ti·ªán l·ª£i 24/7</h1>
    <p>Circle K & GS25 - Lu√¥n b√™n b·∫°n m·ªçi l√∫c, m·ªçi n∆°i</p>
    <a href="#stores" class="btn">T√¨m c·ª≠a h√†ng g·∫ßn b·∫°n</a>
  </div>
</section>

<!-- ================= ABOUT ================= -->
<section id="about" class="about">
  <h2>V·ªÅ Circle K & GS25</h2>
  <p>
    Circle K & GS25 l√† chu·ªói c·ª≠a h√†ng ti·ªán l·ª£i h√†ng ƒë·∫ßu, ho·∫°t ƒë·ªông 24/7,
    mang ƒë·∫øn ƒëa d·∫°ng s·∫£n ph·∫©m t·ª´ ƒë·ªì ƒÉn nhanh, n∆∞·ªõc u·ªëng, c√† ph√™, kem,
    ƒë·∫øn c√°c d·ªãch v·ª• ti·ªán √≠ch thi·∫øt y·∫øu cho cu·ªôc s·ªëng hi·ªán ƒë·∫°i.
  </p>
</section>

<!-- ================= PRODUCTS ================= -->
<section id="products" class="products">
  <h2>S·∫£n ph·∫©m n·ªïi b·∫≠t</h2>
  <div class="product-grid">
    <div class="product-card">
      <img src="https://www.circlek.com/sites/default/files/2023-06/circle_k_coffee_canada_920x575.jpg" alt="N∆∞·ªõc u·ªëng & tr√† s·ªØa">
      <div class="product-info">
        <h3>ü•§ N∆∞·ªõc u·ªëng & tr√† s·ªØa</h3>
        <p>Tr√† s·ªØa tr√¢n ch√¢u, tr√† tr√°i c√¢y, n∆∞·ªõc tƒÉng l·ª±c, n∆∞·ªõc ng·ªçt</p>
      </div>
    </div>
    <div class="product-card">
      <img src="https://www.circlek.com/sites/default/files/2024-03/our_products_920x575.jpg" alt="ƒê·ªì ƒÉn nhanh & b√°nh m√¨">
      <div class="product-info">
        <h3>üçî ƒê·ªì ƒÉn nhanh & b√°nh m√¨</h3>
        <p>B√°nh m√¨ k·∫πp, g√† r√°n, hotdog, c∆°m n·∫Øm, sandwich</p>
      </div>
    </div>
    <div class="product-card">
      <img src="https://www.circlek.com/sites/default/files/2023-06/circle_k_coffee_canada_920x575.jpg" alt="C√† ph√™ & ƒë·ªì u·ªëng n√≥ng">
      <div class="product-info">
        <h3>‚òï C√† ph√™ & ƒë·ªì u·ªëng n√≥ng</h3>
        <p>C√† ph√™ ƒëen, latte, cappuccino, tr√† n√≥ng, matcha</p>
      </div>
    </div>
    <div class="product-card">
      <img src="https://www.circlek.com/sites/default/files/2024-03/our_products_920x575.jpg" alt="Kem & snack">
      <div class="product-info">
        <h3>üç¶ Kem & snack</h3>
        <p>Kem que, kem h·ªôp, snack, b√°nh k·∫πo, ƒë·ªì ƒÉn v·∫∑t</p>
      </div>
    </div>
    <div class="product-card">
      <img src="https://assets1.ccentral.ca/images/v/max_width_1440/s3fs-public/2024-09/20240905_174355.jpg" alt="Bia & ƒë·ªì u·ªëng c√≥ c·ªìn">
      <div class="product-info">
        <h3>üç∫ Bia & ƒë·ªì u·ªëng c√≥ c·ªìn</h3>
        <p>Bia lon, r∆∞·ª£u nh·∫π, ƒë·ªì u·ªëng gi·∫£i kh√°t c√≥ gas</p>
      </div>
    </div>
    <div class="product-card">
      <img src="https://imgproxy.divecdn.com/xCWrndKRHbwmxjMxtC5HkdhiULqSmh6gxopTsNWfMAg/g:ce/rs:fit:1600:0/Z3M6Ly9kaXZlc2l0ZS1zdG9yYWdlL2RpdmVpbWFnZS9DLVN0b3JlX0NhbmR5LmpwZWc=.webp" alt="B√°nh k·∫πo & ƒë·ªì ng·ªçt">
      <div class="product-info">
        <h3>üç¨ B√°nh k·∫πo & ƒë·ªì ng·ªçt</h3>
        <p>K·∫πo d·∫ªo, s√¥ c√¥ la, b√°nh quy, ƒë·ªì ng·ªçt nh·∫≠p kh·∫©u</p>
      </div>
    </div>
    <div class="product-card">
      <img src="https://www.circlek.com/sites/default/files/2024-03/car_wash_920x575px.jpg" alt="ƒê·ªì d√πng c√° nh√¢n">
      <div class="product-info">
        <h3>üß¥ ƒê·ªì d√πng c√° nh√¢n</h3>
        <p>Kem ƒë√°nh rƒÉng, b√†n ch·∫£i, khƒÉn gi·∫•y, s·∫£n ph·∫©m v·ªá sinh</p>
      </div>
    </div>
    <div class="product-card">
      <img src="https://www.circlek.com/sites/default/files/2024-09/b2b_ck_pro_920x575.jpg" alt="ƒê·ªì ƒÉn s·∫µn">
      <div class="product-info">
        <h3>üç± ƒê·ªì ƒÉn s·∫µn</h3>
        <p>C∆°m h·ªôp, salad, tr√°i c√¢y t∆∞∆°i, ƒë·ªì ƒÉn chay</p>
      </div>
    </div>
  </div>
</section>

<!-- ================= STORE LOCATOR ================= -->
<section id="stores" class="store-locator">
  <h2>H·ªá th·ªëng c·ª≠a h√†ng Circle K & GS25</h2>
  <p style="text-align:center; color:#64748b; margin-bottom:30px; font-size:18px;">
    Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c b·∫≠t GPS ƒë·ªÉ t√¨m c·ª≠a h√†ng g·∫ßn b·∫°n nh·∫•t
  </p>

  <div class="wrapMain">
    <!-- LEFT PANEL: Controls & List -->
    <div class="panel">
      <div class="topbar">
        <div class="wrap">
          <div class="brandPill">üó∫Ô∏è WebGIS Stores</div>
          <div class="tabs">
            <div class="tab active" data-brand="CIRCLEK">Circle K & GS25</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <span>ƒêi·ªÅu khi·ªÉn & Danh s√°ch</span>
          <span class="status"><span id="dot" class="dot"></span><span id="status">S·∫µn s√†ng.</span></span>
        </div>

        <div class="cardBody">
          <!-- Search -->
          <div class="acWrap">
            <div class="searchBox">
              <div class="pin">üìç</div>
              <input id="q" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n c·ª≠a h√†ng..." autocomplete="off"/>
              <button class="btn btnPrimary" id="btnSearch">T√¨m</button>
              <button class="btn btnWhite" id="btnMyLoc">V·ªã tr√≠ t√¥i</button>
            </div>
            <div class="acList" id="acList"></div>
          </div>
          <div class="hint">
            Tip: Kh√¥ng mu·ªën b·∫≠t GPS üëâ click tr·ª±c ti·∫øp l√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠.
          </div>

          <div class="toggleRow" style="margin-top:12px">
            <label style="display:flex;gap:8px;align-items:center;margin:0">
              <input type="checkbox" id="autoBounds"/>
              Auto t·∫£i theo khung b·∫£n ƒë·ªì
            </label>
            <span>‚Ä¢ Enter ƒë·ªÉ t√¨m nhanh</span>
          </div>

          <!-- Filters -->
          <div class="row" style="margin-top:12px">
            <div class="field" style="max-width:150px">
              <label>B√°n k√≠nh (km)</label>
              <select id="radiusKm">
                <option value="0.2">0.2</option>
                <option value="0.5" selected>0.5</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="5">5</option>
              </select>
            </div>

            <div class="field">
              <label>Qu·∫≠n / Huy·ªán</label>
              <select id="districtSel">
                <option value="">T·∫•t c·∫£</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn btnBlue" id="btnNearby">T√¨m quanh v·ªã tr√≠</button>
            <button class="btn btnWhite" id="btnLoadBounds">T·∫£i trong khung</button>
            <button class="btn btnWhite" id="btnToggleMarkers">·∫®n marker</button>
            <button class="btn btnWhite" id="btnClearRoute">X√≥a ƒë∆∞·ªùng</button>
            <button class="btn btnWhite" id="btnReset">Reset</button>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>L·ªçc trong danh s√°ch</label>
              <input id="filterText" placeholder="G√µ t√™n / ƒë·ªãa ch·ªâ..." />
            </div>
            <button class="btn btnWhite" id="btnSortNear">G·∫ßn nh·∫•t</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btnWhite mini" id="btnExport">Export CSV</button>
            <button class="btn btnWhite mini" id="btnFav">‚≠ê Favorites</button>
            <button class="btn btnWhite mini" id="btnHistory">üïò History</button>
          </div>

          <div style="margin-top:12px;font-weight:1000;font-size:13px">Danh s√°ch c·ª≠a h√†ng</div>
          <div class="list" id="storeList" style="margin-top:10px"></div>

          <!-- Directions panel -->
          <div id="dirBox" style="margin-top:12px; display:none; border:1px solid var(--border); border-radius:14px; overflow:hidden">
            <div style="padding:10px 12px; font-weight:1000; font-size:13px; background:#f8fafc; border-bottom:1px solid var(--border)">
              üß≠ Ch·ªâ ƒë∆∞·ªùng
              <span id="dirSummary" style="color:#64748b; font-weight:900; margin-left:6px"></span>
            </div>
            <div id="dirSteps" style="padding:10px 12px; font-size:13px; line-height:1.5; max-height:220px; overflow:auto"></div>
          </div>

        </div>
      </div>
    </div>

    <!-- RIGHT PANEL: Map -->
    <div class="panel">
      <div class="cardHead">
        <span>B·∫£n ƒë·ªì</span>
        <span class="status">Click map ƒë·ªÉ ch·ªçn v·ªã tr√≠ ‚Ä¢ Click store ƒë·ªÉ xem ‚Ä¢ Ch·ªâ ƒë∆∞·ªùng </span>
      </div>
      <div id="map"></div>
    </div>
  </div>
</section>

<!-- ================= FOOTER ================= -->
<footer>
  ¬© 2026 Circle K & GS25 ‚Äì WebGIS Store Locator  
  <br>
  Design & Development by <b>Thuan</b>
</footer>

<!-- ================= JAVASCRIPT ================= -->
<script>
// ======================
// DOM Elements
// ======================
const out = document.getElementById('result');
const statusEl = document.getElementById('status');
const dot = document.getElementById('dot');

const qInput = document.getElementById('q');
const acList = document.getElementById('acList');

const radiusSel = document.getElementById('radiusKm');
const districtSel = document.getElementById('districtSel');
const filterText = document.getElementById('filterText');
const autoBounds = document.getElementById('autoBounds');

const storeListEl = document.getElementById('storeList');

const dirBox = document.getElementById("dirBox");
const dirSummary = document.getElementById("dirSummary");
const dirSteps = document.getElementById("dirSteps");

// ======================
// State
// ======================
let ACTIVE_BRAND = "CIRCLEK";
let currentCenter = null; // {lat, lng, display?}
let markersVisible = true;

let STORES = [];
let STORES_VIEW = [];
let lastNearbyItems = [];

let LIST_LIMIT = 60;

let routingControl = null;
let radiusCircle = null;

const LS_FAV = "webgis:favs:v1";
const LS_HIS = "webgis:history:v1";

// ======================
// Utils
// ======================
function setStatus(text, ok=true){
  statusEl.textContent = text || '';
  dot.className = ok ? "dot" : "dot bad";
  statusEl.style.color = ok ? '#16a34a' : '#ef4444';
}

function showJSON(obj){
  if(!out) return;              
  out.textContent = JSON.stringify(obj, null, 2);
}


function esc(s){
  return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function debounce(fn, ms=250){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

function haversineKm(lat1,lng1,lat2,lng2){
  const R=6371.0;
  const toRad=x=>x*Math.PI/180;
  const dlat=toRad(lat2-lat1);
  const dlng=toRad(lng2-lng1);
  const a=Math.sin(dlat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dlng/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function getRadiusKm(){ return Number(radiusSel.value || 0.5); }
function getDistrict(){ return (districtSel.value||"").trim(); }

function parseLatLng(text){
  const m = (text||"").trim().match(/^\s*(-?\d+(?:\.\d+)?)\s*[,; ]\s*(-?\d+(?:\.\d+)?)\s*$/);
  if(!m) return null;
  const lat = Number(m[1]), lng = Number(m[2]);
  if(Number.isFinite(lat) && Number.isFinite(lng) && lat>=-90 && lat<=90 && lng>=-180 && lng<=180){
    return {lat, lng};
  }
  return null;
}

async function fetchJSON(url){
  try{
    const res = await fetch(url);
    const text = await res.text();
    let data = null;
    try{ data = JSON.parse(text); }
    catch{ data = { ok:false, error:"Loading...", raw:text.slice(0,250) }; }
    showJSON(data);
    if(!res.ok || data.ok === false){
      setStatus(data.error || `HTTP ${res.status}`, false);
    }else{
      setStatus(data.message || "OK ‚úÖ", true);
    }
    return {res, data};
  }catch(e){
    showJSON({ok:false, error:String(e)});
    setStatus("L·ªói m·∫°ng/Fetch ‚ùå", false);
    return {res:null, data:null};
  }
}

async function postJSON(url, body){
  try{
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const text = await res.text();
    let data = null;
    try{ data = JSON.parse(text); }
    catch{ data = { ok:false, error:"Response is not JSON", raw:text.slice(0,250) }; }
    showJSON(data);
    if(!res.ok || data.ok === false){
      setStatus(data.error || `HTTP ${res.status}`, false);
    }else{
      setStatus(data.message || "OK ‚úÖ", true);
    }
    return {res, data};
  }catch(e){
    showJSON({ok:false, error:String(e)});
    setStatus("L·ªói m·∫°ng/Fetch ‚ùå", false);
    return {res:null, data:null};
  }
}

function showDirections(summaryText, stepsHtml){
  dirBox.style.display = "block";
  dirSummary.textContent = summaryText || "";
  dirSteps.innerHTML = stepsHtml || "";
}
function hideDirections(){
  dirBox.style.display = "none";
  dirSummary.textContent = "";
  dirSteps.innerHTML = "";
}

// ======================
// Map Initialization
// ======================
const map = L.map("map").setView([10.7769, 106.7009], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap contributors | WebGIS Project ‚Äì Thuan"
}).addTo(map);

const userIcon = L.divIcon({
  className:"",
  html:`<div style="width:16px;height:16px;border-radius:999px;background:#2563eb;border:3px solid #fff;box-shadow:0 10px 20px rgba(37,99,235,.35)"></div>`,
  iconSize:[16,16], iconAnchor:[8,8]
});
const storeIcon = L.divIcon({
  className:"",
  html:`<div style="width:18px;height:18px;border-radius:7px;background:linear-gradient(180deg,#e31c23,#c3141a);border:2px solid #fff;box-shadow:0 12px 22px rgba(227,28,35,.35)"></div>`,
  iconSize:[18,18], iconAnchor:[9,9]
});

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

let userMarker = null;

function clearRoute(){
  if(routingControl){
    map.removeControl(routingControl);
    routingControl = null;
  }
  hideDirections();
}

function drawRadiusCircle(){
  if(!currentCenter) return;
  const m = getRadiusKm() * 1000;
  if(radiusCircle) radiusCircle.remove();
  radiusCircle = L.circle([currentCenter.lat, currentCenter.lng], {
    radius: m,
    weight: 2,
    opacity: .9,
    fillOpacity: .10
  }).addTo(map);
}

function setUser(lat, lng, display=""){
  currentCenter = {lat, lng, display};
  if(userMarker) userMarker.remove();
  userMarker = L.marker([lat, lng], {icon:userIcon}).addTo(map);
  userMarker.bindPopup(`<b>V·ªã tr√≠</b><br/>${esc(display || (lat.toFixed(6)+", "+lng.toFixed(6)))}`).openPopup();
  map.setView([lat, lng], 16);
  clearRoute();
  drawRadiusCircle();
}

function renderMarkers(list){
  cluster.clearLayers();
  if(!markersVisible) return;
  list.forEach(s=>{
    const m = L.marker([s.lat, s.lng], {icon:storeIcon});
    m.on("click", ()=> openStorePopup(s));
    cluster.addLayer(m);
  });
}

function openStorePopup(s){
  const html = `
    <b>${esc(s.name || "C·ª≠a h√†ng")}</b><br/>
    ${esc(s.address_db || "")}<br/>
    <small style="color:#64748b">Qu·∫≠n: ${esc(s.district || "")}</small><br/>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btnWhite mini" onclick="routeToStore(${s.lat},${s.lng},'${esc(s.name||"Store")}')">üß≠ Ch·ªâ ƒë∆∞·ªùng</button>
      <button class="btn btnWhite mini" onclick="toggleFav(${s.id})">‚≠ê Y√™u th√≠ch</button>
    </div>
  `;
  L.popup({maxWidth:360})
    .setLatLng([s.lat, s.lng])
    .setContent(html)
    .openOn(map);
}

window.routeToStore = function(lat, lng, name){
  if(!currentCenter){
    setStatus("Ch∆∞a c√≥ v·ªã tr√≠. Click map ho·∫∑c b·∫•m V·ªã tr√≠ t√¥i.", false);
    return;
  }
  clearRoute();

  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(currentCenter.lat, currentCenter.lng),
      L.latLng(lat, lng),
    ],
    addWaypoints:false,
    draggableWaypoints:false,
    routeWhileDragging:false,
    show: false
  }).addTo(map);

  routingControl.on("routesfound", (e)=>{
    const r = e.routes[0];
    const km = (r.summary.totalDistance/1000).toFixed(2);
    const min = (r.summary.totalTime/60).toFixed(0);
    setStatus(`T·ªõi ${name}: ${km} km ~ ${min} ph√∫t`, true);

    const inst = (r.instructions || []).map((it, idx)=>{
      const dkm = it.distance ? (it.distance/1000).toFixed(2)+" km" : "";
      const txt = (it.text || "").replaceAll("<","&lt;").replaceAll(">","&gt;");
      return `<div style="padding:8px 0;border-bottom:1px dashed #e5e7eb">
                <b>${idx+1}.</b> ${txt}
                <div style="color:#64748b;font-weight:800">${dkm}</div>
              </div>`;
    }).join("");

    showDirections(`${km} km ‚Ä¢ ${min} ph√∫t`, inst || `<div style="color:#64748b;font-weight:900">Kh√¥ng c√≥ h∆∞·ªõng d·∫´n chi ti·∫øt.</div>`);
  });

  routingControl.on("routingerror", ()=>{
    setStatus("Kh√¥ng t√¨m ƒë∆∞·ª£c ƒë∆∞·ªùng. Th·ª≠ l·∫°i!", false);
  });
};

// ======================
// Map Events
// ======================
map.on("click", async (e)=>{
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;
  setUser(lat, lng, "ƒêang l·∫•y ƒë·ªãa ch·ªâ...");

  const {res, data} = await fetchJSON(`/tools/reverse-geo/?lat=${lat}&lon=${lng}`);
  if(res && res.ok && data.ok && data.display){
    setUser(lat, lng, data.display_address);
    qInput.value = data.display_address;
  }else{
    setUser(lat, lng, "Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ ‚Äî d√πng t·ªça ƒë·ªô");
    qInput.value = `${lat},${lng}`;
  }
  await loadNearby();
});

const loadBoundsDebounced = debounce(async ()=>{
  if(autoBounds.checked){
    await loadInBounds();
  }
}, 450);
map.on("moveend", loadBoundsDebounced);

// ======================
// Favorites & History
// ======================
function loadFavs(){
  try{ return JSON.parse(localStorage.getItem(LS_FAV) || "[]"); }catch{ return []; }
}
function saveFavs(arr){
  localStorage.setItem(LS_FAV, JSON.stringify(arr));
}
window.toggleFav = function(id){
  const favs = loadFavs();
  const exists = favs.includes(id);
  const next = exists ? favs.filter(x=>x!==id) : [...favs, id];
  saveFavs(next);
  setStatus(exists ? "ƒê√£ b·ªè y√™u th√≠ch." : "ƒê√£ th√™m y√™u th√≠ch ‚≠ê", true);
};

function addHistory(item){
  try{
    const arr = JSON.parse(localStorage.getItem(LS_HIS) || "[]");
    const next = [item, ...arr.filter(x=>x && x.text !== item.text)].slice(0, 20);
    localStorage.setItem(LS_HIS, JSON.stringify(next));
  }catch{}
}

// ======================
// Render List
// ======================
function renderList(arr){
  storeListEl.innerHTML = "";
  if(!arr.length){
    storeListEl.innerHTML = `<div style="color:#64748b;font-weight:900">Ch∆∞a c√≥ d·ªØ li·ªáu. Click map ho·∫∑c b·∫•m V·ªã tr√≠ t√¥i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>`;
    return;
  }

  const favs = loadFavs();
  const slice = arr.slice(0, LIST_LIMIT);

  slice.forEach(s=>{
    const div = document.createElement("div");
    div.className = "item";

    const d = currentCenter ? haversineKm(currentCenter.lat, currentCenter.lng, s.lat, s.lng) : (s.distance_km ?? null);
    const distTxt = (d!=null) ? `${Number(d).toFixed(2)} km` : "";
    const isFav = favs.includes(s.id);

    div.innerHTML = `
      <b>${esc(s.name || "Store")} ${isFav ? "‚≠ê" : ""}</b>
      <small>${esc(s.address_db || "")}</small>
      <small>Qu·∫≠n: <b>${esc(s.district || "")}</b> ‚Ä¢ ${distTxt ? `Kho·∫£ng c√°ch: <b>${esc(distTxt)}</b>` : ""}</small>
      <div class="actions">
        <button class="btn btnWhite mini" data-act="fly">üìå Xem</button>
        <button class="btn btnWhite mini" data-act="route">üß≠ Ch·ªâ ƒë∆∞·ªùng</button>
        <button class="btn btnWhite mini" data-act="fav">‚≠ê Y√™u th√≠ch</button>
      </div>
    `;

    div.querySelector('[data-act="fly"]').onclick = (ev)=>{
      ev.stopPropagation();
      map.setView([s.lat, s.lng], 18);
      openStorePopup(s);
    };
    div.querySelector('[data-act="route"]').onclick = (ev)=>{
      ev.stopPropagation();
      map.setView([s.lat, s.lng], 18);
      window.routeToStore(s.lat, s.lng, (s.name||"Store"));
    };
    div.querySelector('[data-act="fav"]').onclick = (ev)=>{
      ev.stopPropagation();
      window.toggleFav(s.id);
      renderList(STORES_VIEW);
    };

    div.onclick = ()=>{
      map.setView([s.lat, s.lng], 18);
      openStorePopup(s);
    };

    storeListEl.appendChild(div);
  });

  if(arr.length > LIST_LIMIT){
    const more = document.createElement("div");
    more.className = "item";
    more.style.textAlign = "center";
    more.style.fontWeight = "1000";
    more.style.color = "#2563eb";
    more.innerHTML = `Xem th√™m (${arr.length - LIST_LIMIT})`;
    more.onclick = ()=>{
      LIST_LIMIT += 60;
      renderList(STORES_VIEW);
    };
    storeListEl.appendChild(more);
  }
}

function applyFilter(){
  LIST_LIMIT = 60;
  const t = (filterText.value||"").trim().toLowerCase();
  const d = getDistrict().toLowerCase();

  STORES_VIEW = STORES.filter(s=>{
    const hay = ((s.name||"")+" "+(s.address_db||"")).toLowerCase();
    const okText = !t || hay.includes(t);
    const okDist = !d || ((s.district||"").toLowerCase() === d);
    return okText && okDist;
  });

  renderList(STORES_VIEW);
  renderMarkers(STORES_VIEW);
}

function sortByNearest(){
  if(!currentCenter){
    setStatus("Ch∆∞a c√≥ v·ªã tr√≠ ƒë·ªÉ s·∫Øp x·∫øp.", false);
    return;
  }
  STORES_VIEW = [...STORES_VIEW].sort((a,b)=>{
    const da = haversineKm(currentCenter.lat, currentCenter.lng, a.lat, a.lng);
    const db = haversineKm(currentCenter.lat, currentCenter.lng, b.lat, b.lng);
    return da - db;
  });
  renderList(STORES_VIEW);
  setStatus("ƒê√£ s·∫Øp x·∫øp g·∫ßn nh·∫•t ‚úÖ", true);
}

// ======================
// API Calls
// ======================
async function refreshDistricts(){
  const {res, data} = await fetchJSON(`/tools/districts/?brand=${encodeURIComponent(ACTIVE_BRAND)}`);
  if(!res || !res.ok || !data.ok) return;
  const items = data.districts || [];
  districtSel.innerHTML = `<option value="">T·∫•t c·∫£</option>` + items.map(x=>`<option value="${esc(x)}">${esc(x)}</option>`).join("");
}

async function loadNearby(){
  if(!currentCenter){
    setStatus("Ch∆∞a c√≥ v·ªã tr√≠. Click map ho·∫∑c b·∫•m V·ªã tr√≠ t√¥i.", false);
    return;
  }
  const radius = getRadiusKm();
  const district = getDistrict();
  const url = `/tools/stores-in-radius/?lat=${currentCenter.lat}&lon=${currentCenter.lng}&radius_km=${radius}&brand=${encodeURIComponent(ACTIVE_BRAND)}&district=${encodeURIComponent(district)}`;
  const {res, data} = await fetchJSON(url);
  if(!res || !res.ok || !data.ok) return;

  STORES = (data.stores || []).map(x=>({
    id:x.id, name:x.name, brand:x.brand,
    address_db:x.address_db||"",
    district:x.district||"",
    lat:Number(x.lat),
    lng:Number(x.lon),
    distance_km:x.distance_km
  }));
  lastNearbyItems = STORES;

  drawRadiusCircle();
  applyFilter();
  sortByNearest();
  setStatus(`T√¨m th·∫•y ${STORES.length} c·ª≠a h√†ng quanh b·∫°n `, true);
}

async function loadInBounds(){
  const district = getDistrict();
  const b = map.getBounds();
  const url = `/tools/stores-in-bounds/?brand=${encodeURIComponent(ACTIVE_BRAND)}&district=${encodeURIComponent(district)}&south=${b.getSouth()}&west=${b.getWest()}&north=${b.getNorth()}&east=${b.getEast()}`;
  const {res, data} = await fetchJSON(url);
  if(!res || !res.ok || !data.ok) return;

  STORES = (data.stores || []).map(x=>({
    id:x.id, name:x.name, brand:x.brand,
    address_db:x.address_db||"",
    district:x.district||"",
    lat:Number(x.lat),
    lng:Number(x.lon),
  }));
  lastNearbyItems = [];
  applyFilter();
  setStatus(`ƒê√£ t·∫£i ${STORES.length} c·ª≠a h√†ng trong khung b·∫£n ƒë·ªì ‚úÖ`, true);
}

async function searchStoreDBFirst(){
  const q = (qInput.value || "").trim();
  if(q.length < 2) return false;

  const district = getDistrict();
  setStatus("ƒêang t√¨m trong DB...");
  const {res, data} = await fetchJSON(`/tools/search-stores/?brand=${encodeURIComponent(ACTIVE_BRAND)}&q=${encodeURIComponent(q)}&district=${encodeURIComponent(district)}&limit=200`);
  if(!res || !res.ok || !data.ok) return false;

  const items = (data.stores || []).map(x=>({
    id:x.id, name:x.name, brand:x.brand,
    address_db:x.address_db||"",
    district:x.district||"",
    lat:Number(x.lat),
    lng:Number(x.lon),
  }));

  if(!items.length) return false;

  STORES = items;
  applyFilter();

  const bounds = L.latLngBounds(items.map(s=>[s.lat, s.lng]));
  map.fitBounds(bounds.pad(0.25));

  setStatus(`T√¨m DB: ${items.length} k·∫øt qu·∫£ ‚úÖ`, true);
  return true;
}

async function smartSearch(){
  const q = (qInput.value||"").trim();
  if(!q){
    setStatus("Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t√™n c·ª≠a h√†ng.", false);
    return;
  }
  addHistory({type:"search", text:q, ts:Date.now()});

  const ll = parseLatLng(q);

  const body = {
    ten: ACTIVE_BRAND,
    dia_chi: q,
    lat: ll ? ll.lat : null,
    lng: ll ? ll.lng : null,
    max_km: getRadiusKm()
  };

  setStatus("ƒêang t√¨m ƒë·ªãa ch·ªâ (Nominatim)...");
  const {res, data} = await postJSON("/tools/smart-search/", body);
  if(!res || !res.ok || !data.location) return;

  setUser(Number(data.location.lat), Number(data.location.lon), data.location.display_address || q);
  await loadNearby();
}

// ======================
// Autocomplete
// ======================
function hideAC(){ acList.style.display="none"; acList.innerHTML=""; }
function showAC(items){
  if(!items || !items.length){ hideAC(); return; }
  acList.innerHTML = items.map((it, idx)=>`
    <div class="acItem" data-idx="${idx}">
      ${esc(it.display || "")}
    </div>
  `).join("");
  acList.style.display="block";

  acList.querySelectorAll(".acItem").forEach(el=>{
    el.onclick = ()=>{
      const i = Number(el.dataset.idx);
      const it = items[i];
      if(!it) return;
      hideAC();
      const lat = Number(it.lat);
      const lon = Number(it.lon);
      qInput.value = it.display || "";
      setUser(lat, lon, it.display || "");
      addHistory({type:"suggest", text: it.display || "", ts: Date.now()});
      loadNearby();
    };
  });
}

const suggestDebounced = debounce(async ()=>{
  const q = (qInput.value||"").trim();
  if(q.length < 3){ hideAC(); return; }

  const {res, data} = await fetchJSON(`/tools/suggest/?q=${encodeURIComponent(q)}`);
  if(!res || !res.ok || !data.ok){ hideAC(); return; }
  showAC(data.items || []);
}, 280);

qInput.addEventListener("input", suggestDebounced);
document.addEventListener("click", (e)=>{
  if(!acList.contains(e.target) && e.target !== qInput) hideAC();
});

qInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    document.getElementById("btnSearch").click();
    hideAC();
  }
});

// ======================
// Button Handlers
// ======================
document.getElementById("btnSearch").onclick = async ()=>{
  const okDB = await searchStoreDBFirst();
  if(okDB) return;
  await smartSearch();
};

document.getElementById("btnMyLoc").onclick = ()=>{
  if(!navigator.geolocation){
    setStatus("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation ‚ùå", false);
    return;
  }
  setStatus("ƒêang truy c·∫≠p v·ªã tr√≠...");
  navigator.geolocation.getCurrentPosition(
    async (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      setUser(lat, lng, "V·ªã tr√≠ hi·ªán t·∫°i");

      const {res, data} = await fetchJSON(`/tools/reverse-geo/?lat=${lat}&lon=${lng}`);
      if(res && res.ok && data.ok && data.display_address){
        setUser(lat, lng, data.display_address);
        qInput.value = data.display_address;
      }else{
        qInput.value = `${lat},${lng}`;
      }

      addHistory({type:"gps", text:"My location", ts:Date.now()});
      await loadNearby();
    },
    (err)=>{
      let msg = "Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠.";
      if(err.code === 1) msg = "B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn v·ªã tr√≠.";
      else if(err.code === 2) msg = "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c v·ªã tr√≠.";
      else if(err.code === 3) msg = "L·∫•y v·ªã tr√≠ b·ªã timeout.";
      setStatus("‚ùå " + msg + " (B·∫°n c√≥ th·ªÉ click b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠)", false);
    },
    {enableHighAccuracy:true, timeout:10000, maximumAge:0}
  );
};

document.getElementById("btnNearby").onclick = loadNearby;
document.getElementById("btnLoadBounds").onclick = loadInBounds;

document.getElementById("btnToggleMarkers").onclick = ()=>{
  markersVisible = !markersVisible;
  document.getElementById("btnToggleMarkers").textContent = markersVisible ? "·∫®n marker" : "Hi·ªán marker";
  renderMarkers(STORES_VIEW);
};

document.getElementById("btnClearRoute").onclick = ()=>{
  clearRoute();
  setStatus("ƒê√£ x√≥a ƒë∆∞·ªùng.", true);
};

document.getElementById("btnReset").onclick = ()=>{
  currentCenter = null;
  clearRoute();
  if(userMarker){ userMarker.remove(); userMarker=null; }
  if(radiusCircle){ radiusCircle.remove(); radiusCircle=null; }
  cluster.clearLayers();
  STORES = []; STORES_VIEW = []; lastNearbyItems = [];
  renderList([]);
  map.setView([10.7769, 106.7009], 12);
  setStatus("ƒê√£ reset. Click map ho·∫∑c b·∫•m V·ªã tr√≠ t√¥i ƒë·ªÉ b·∫Øt ƒë·∫ßu.", true);
};

document.getElementById("btnSortNear").onclick = sortByNearest;

document.getElementById("btnExport").onclick = ()=>{
  const items = (lastNearbyItems && lastNearbyItems.length) ? lastNearbyItems : STORES_VIEW;
  if(!items.length){ setStatus("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export.", false); return; }

  const header = ["id","brand","name","district","address","lat","lng","distance_km"];
  const lines = [header.join(",")];
  for(const s of items){
    const row = [
      s.id ?? "",
      s.brand ?? "",
      s.name ?? "",
      s.district ?? "",
      s.address_db ?? "",
      s.lat ?? "",
      s.lng ?? "",
      s.distance_km ?? ""
    ].map(v => `"${String(v).replaceAll('"','""')}"`);
    lines.push(row.join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `export_${ACTIVE_BRAND.toLowerCase()}_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  setStatus("ƒê√£ export CSV ‚úÖ", true);
};

document.getElementById("btnFav").onclick = ()=>{
  const favs = loadFavs();
  if(!favs.length){
    setStatus("Ch∆∞a c√≥ c·ª≠a h√†ng y√™u th√≠ch.", false);
    return;
  }
  const favList = STORES.filter(s=>favs.includes(s.id));
  if(!favList.length){
    setStatus("Favorites ch∆∞a n·∫±m trong list hi·ªán t·∫°i. H√£y t√¨m quanh v·ªã tr√≠ tr∆∞·ªõc.", false);
    return;
  }
  STORES_VIEW = favList;
  renderList(STORES_VIEW);
  renderMarkers(STORES_VIEW);
  setStatus(`ƒêang xem Favorites (${STORES_VIEW.length}) ‚≠ê`, true);
};

document.getElementById("btnHistory").onclick = ()=>{
  try{
    const arr = JSON.parse(localStorage.getItem(LS_HIS) || "[]");
    if(!arr.length){ setStatus("Ch∆∞a c√≥ l·ªãch s·ª≠.", false); return; }
    showJSON({history: arr});
    setStatus("ƒê√£ m·ªü l·ªãch s·ª≠ (xem ·ªü Debug JSON).", true);
  }catch{
    setStatus("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c l·ªãch s·ª≠.", false);
  }
};

filterText.addEventListener("input", debounce(applyFilter, 200));

districtSel.addEventListener("change", ()=>{
  applyFilter();
  if(currentCenter) loadNearby();
});

radiusSel.addEventListener("change", ()=>{
  drawRadiusCircle();
  if(currentCenter) loadNearby();
});

// ======================
// Brand Tabs
// ======================
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    ACTIVE_BRAND = t.dataset.brand;
    setStatus(`ƒê√£ ch·ªçn ${ACTIVE_BRAND}.`, true);
    refreshDistricts();
    if(currentCenter) loadNearby();
  };
});

// ======================
// Initialization
// ======================
renderList([]);
showJSON({result:"JSON ·ªü ƒë√¢y"});
refreshDistricts();
setStatus("S·∫µn s√†ng. Click map ƒë·ªÉ ch·ªçn v·ªã tr√≠.", true);
</script>
</body>
</html>